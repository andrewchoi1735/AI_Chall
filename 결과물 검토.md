# ✅ 결과물 검토 및 보완 설명

## 1) AI 출력의 한계 또는 오류

* **마이페이지 진입 검증의 취약한 가정**

  * 초안은 `"마이페이지/내 정보/내 계정/내 프로필"` 같은 특정 텍스트가 존재한다는 전제를 사용 → 실제 화면에는 해당 문구가 없어 **False Negative** 발생.
* **세션 지속 방식에 대한 단순화**

  * `storage_state()`만으로 \*\*자동로그인(로그인 상태 유지)\*\*가 된다고 가정했으나, 사이트는 쿠키 + `localStorage`(및 경우에 따라 디바이스/토큰) 조합을 사용 → 새 컨텍스트에서 세션 미인정.
* **`add_init_script` 사용 오류**

  * Playwright Python은 `add_init_script(script, arg)` 시그니처를 지원하지 않음 → **직렬화된 문자열**만 허용. 콜백+데이터 2인자 형태 사용으로 `TypeError` 발생.
* **타이밍 이슈 간과**

  * 로그인 직후 바로 `storage_state` 저장 → 서버 쿠키/토큰 발급이 **완전히 반영되기 전** 저장될 수 있음.
* **모바일 컨텍스트/도메인 경계**

  * `m.albamon.com` vs `.albamon.com` 쿠키 범위 차이 고려 부족 → 특정 컨텍스트에서 쿠키가 적용되지 않을 수 있음.
* **로케이터 안정성**

  * 텍스트 기반 단일 휴리스틱 의존 → A/B 테스트, Ajax 지연, UI 개편 시 취약.

---

## 2) 수정/보완한 내용 및 이유

### (A) 마이페이지 진입 검증 강화

* **URL 패턴 + 화면 마커 텍스트 + 셀렉터 기반 대기**로 다층 검증:

  * URL: `/personal/mypage|/mypage|/my|account|user` 정규식 확인
  * 텍스트 마커: `회원정보/이력서/지원현황/스크랩/최근본알바` 중 1개 이상 존재 확인
  * 셀렉터 대기: `page.wait_for_selector("text=회원정보", timeout=2000)` 추가
* **이유:** UI 텍스트/레이아웃 변동·지연에 대한 **방어적 설계**로 False Negative 최소화.

### (B) 자동로그인(로그인 유지) 시나리오 재설계

* **토큰/쿠키 “직접 주입” 방식** 채택:

  1. 로그인 컨텍스트에서 `context.cookies()` + `localStorage` 추출
  2. 새 컨텍스트에서 `add_cookies()`로 쿠키 주입
  3. `add_init_script()`에 **JSON 직렬화**로 변환한 `localStorage`를 복원하는 스크립트 삽입
* **이유:** 일부 서비스는 `storage_state()`만으로 불충분(remember/autoLogin/refresh 토큰 별도 저장) → **실제 브라우저 상태 복제**가 신뢰도 높음.

### (C) `add_init_script` 사용법 교정

* **수정:** Python에서는 인자 1개(스크립트 문자열)만 허용 → `localStorage` map을 **`json.dumps`로 직렬화**해 스크립트 내부에서 `JSON.parse()`로 복원.
* **이유:** 타입 오류 해결 + 브라우저 측에서 안전하게 데이터 복원.

### (D) 타이밍 안정화

* **로그인 후 추가 대기(1.2–2.0s)** 후에 마이페이지 진입/스토리지 저장.
* **이유:** 토큰/쿠키 세팅이 지연되는 환경(네트워크/서버)에서 **플레이키한 실패 방지**.

### (E) 내비게이션 폴백 개선

* **클릭 실패 시 직접 이동**(e.g., `goto('/personal/mypage')`)을 최종 폴백으로 추가.
* **이유:** 햄버거 메뉴/동적 렌더링 변동에 불안정한 클릭 시나리오 보완.

### (F) pytest 마커 정식 등록

* `pytest.ini`에 `albamon_e2e` 마커 등록하여 경고 제거 및 실행 편의성 확보.

---

## 3) 실무 관점에서 필요한 추가 예외 케이스

> 테스트 방법론 관점(Given-When-Then)과 **양/음성 케이스**, **경계/회복/보안**을 아우르는 확장 제안입니다.

### 인증/세션

* **리프레시 토큰 만료/재발급 플로우**

  * Given 만료 직전 토큰 상태
  * When 새 컨텍스트에서 마이페이지 접근
  * Then 무중단 재인증(백그라운드 토큰 갱신) 또는 로그인 화면 리다이렉트 검증
* **도메인 경계 쿠키**

  * `.albamon.com` vs `m.albamon.com` 혼재 시 세션 인정 여부
* **다중 기기 동시 로그인**

  * 한 컨텍스트에서 로그아웃 시 다른 컨텍스트 세션 무효화 여부

### UI/접근성/로케이터

* **A/B 테스트/다국어(ko/ja/en) 스위치** 시 로케이터 fallback
* **비표준 폰트 로딩 지연**(FOIT/FOUT)에서 텍스트 기반 검증 대기 전략
* **ARIA Role 변화/스켈레톤 UI** 로딩 완료 지표(스피너 사라짐) 대기

### 보안/정책

* **캡차/휴대폰 인증 개입 시 우회/중단 처리**

  * 캡차 감지 → 테스트 중단 및 스킵 마커(`@pytest.mark.skipif`) 조건화
* **비밀번호 마스킹/클립보드 접속 제한** 검증
* **Brute Force 방지**

  * 연속 실패 5회 후 쿨다운/캡차 노출 확인

### 폼 유효성/에러 메시지

* **아이디/비번 공백, 특수문자, 길이 경계값**
* **서버 에러(5xx) 및 네트워크 타임아웃** 시 리트라이/에러 배너 확인
* **에러 메시지 국제화(i18n) 키 누락**(원문 키 노출) 검증

### 접근 경로/리다이렉트

* **로그인 필요 페이지 직접 접근 리다이렉트 체인**

  * 로그인 전 `/personal/mypage` 접근 → 로그인 후 원래 목적지 복귀 확인(`redirect_url` 유지)
* **백/포워드 내비게이션**에서 세션 유지

### 성능/회복력

* **느린 네트워크(3G) 시나리오**

  * `page.set_extra_http_headers`/`route`로 지연 주입 후 UX 저하 없는지 확인
* \*\*리소스 실패(이미지/CDN 에러)\*\*에도 핵심 기능 영향 없는지

### 접근성/품질 게이트

* **키보드 전용 탭 순서/포커스 트랩** 확인
* **시각 요소 없이(텍스트만) 주요 액션 가능한지**

### 로깅/관측성

* **주요 전환 포인트 스크린샷/Har Trace** 자동 보관
* **실패 시 콘솔/네트워크 로그 첨부**로 원인 분석 시간 단축

---

## 권장 테스트 구조(샘플 체크리스트)

* [ ] **로케이터 우선순위:** get\_by\_role/label/placeholder → 폴백(CSS/Text)
* [ ] **대기 전략:** `wait_for_url` + 스피너/마커 `wait_for_selector`
* [ ] **토큰 영속화:** 쿠키 + `localStorage` 동시 주입, 도메인 경계 확인
* [ ] **폴백 내비게이션:** 클릭 실패 시 `goto()` 폴백
* [ ] **타임아웃 표준화:** 네트워크/렌더링 별 SLA 기반 타임아웃 상수화
* [ ] **마커 등록:** `pytest.ini` 마커 선언으로 실행 일관성 확보
* [ ] **증적 수집:** 실패 케이스에 자동 스크린샷/트레이스 저장
* [ ] **환경 분리:** 모바일/데스크톱 디바이스 프로필 파라미터화
* [ ] **보안/정책 훼손 방지:** 캡차/2FA 감지 시 테스트 스킵 가드
* [ ] **i18n 가변성:** 다국어 텍스트 마커 테이블 관리로 유지보수성 개선

---

## 향후 개선 제안

* **“핵심 토큰만 선별 주입” 유틸**: `NAC/NACT/AM_USER_UUID` 등 실제로 세션에 관여하는 키만 필터링하여 주입(테넌트/환경 분기 대응)
* **플레이북화**: 공통 헬퍼(`expect_dashboard`, `ensure_logged_in`)로 시나리오 재사용성 향상
* **관측성 강화**: 실패 시 자동으로 `network.har`/`trace.zip` 생성 및 CI 아티팩트 업로드
* **플래키 감쇠**: 지수 백오프 리트라이(중앙값 타임아웃), `waitForLoadState('networkidle')` 병행

---

> 이 문서는 `.md` 파일로 바로 사용 가능합니다.
> 추가로 원하시면 **핵심 토큰 필터링 유틸**과 **실패 시 트레이스 자동수집** 코드까지 이어서 정리해 드릴게요.
